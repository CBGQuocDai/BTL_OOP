<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" th:href="@{/css/postDetail.css}">
    <script src="https://cdn.ckeditor.com/ckeditor5/43.1.0/ckeditor5.umd.js"></script>
    <link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/43.1.0/ckeditor5.css">
    <style>
        .error{
            margin-top:5px;
            margin-inside: 0;
            margin-bottom:5px;
            padding: 0;
            color:red;
            font-size: 1.3em;
        }
    </style>
</head>
<body>
    <div class="header">
        <ul>
        <li><img style="width: 70px" th:src="@{../file/logo.png}" alt=""></li>
        <li><a href=""><h2>Post</h2></a></li>
        <li><a href=""><h2>Question</h2></a></li>
    </ul>
        <ul class="right">
        <li>
            <div class="find">
                <input type="text" placeholder="Search in FoxGraphy">
                <img th:src="@{../file/searchIcon.png}" alt="">
            </div>
        </li>
        <li><img class="icon" th:src="@{../file/notificationIcon.png}" alt=""></li>
        <li><a href="/Post/create"><img class="icon"  th:src="@{../file/writeBlog.png}" alt=""></a></li>
        <li><a href=""><img class="icon" id="avatar" th:src="@{${avatarUser}}" alt=""></a></li>
    </ul>
    </div>
    <div class="body">
        <div class="sidebar" >
            <ul>
                <li class="vote" >
                    <img id="voteUp" th:src="${userVote==1} ? @{../file/voteUpSelect.png} : @{../file/voteUpDefault.png}" alt="">
                    <h1 id ="voteCount" th:text="${vote}"></h1>
                    <img id="voteDown" th:src="${userVote==-1} ? @{../file/voteDownSelect.png} : @{../file/voteDownDefault.png}" alt="">
                </li>
                <li><img id="bookmark" th:src="${bookmark==0} ? @{../file/bookmark.png}: @{../file/bookmarkSelect.png}" alt=""></li>
                <li><img th:src="@{../file/report.png}" alt=""></li>
            </ul>
        </div>
        <div class="post">
            <div class="info">
                <div class="left">
                    <img th:src="@{${avatarAuthor}}" alt="Author Image">
                    <div class="author">
                        <div class="name">
                            <p th:text="${nameAuthor}"></p>
                            <form id="followForm">
                                <input type="hidden"  name="authorId">
                                <button type="button" id="followButton">Follow</button>
                            </form>
                        </div>
                        <ul class="star">
                            <li><img th:src="@{../file/follower.png}" alt=""> <span>3</span></li>
                            <li><img th:src="@{../file/Blog.png}" alt=""> <span>3</span></li>
                        </ul>
                    </div>
                </div>

                <div class="timePublic">
                    <p th:text="${post.getTimeUp()}"></p>
                    <ul>
                        <li><img th:src="@{../file/watch.png}" alt=""> <span>4</span></li>
                        <li><img th:src="@{../file/comment.png}" alt=""> <span>4</span></li>
                        <li><img th:src="@{../file/bookmark_filled.png}" alt=""> <span>4</span></li>
                    </ul>
                </div>
            </div>
            <h3 class="title" th:text="${post.getTitle()}"></h3>
            <div class="content" th:utext="${post.getContent()}"></div>
            <div class="tag">
                <ul>
                    <li th:each="iteam : ${tags}">
                        <span th:text="${iteam}"></span>
                    </li>
                </ul>
            </div>
            <div class="comment">
                <img th:src="@{${avatarUser}}" alt="">
                <form action="" id="submitComment">
                    <textarea class="comment-content" id ='editor'></textarea>
                    <button id="upComment" class="btn1" type="submit">Up</button>
                </form>
            </div>
            <div class="postComment">

            </div>

        </div>
        <div class="index">

        </div>
    </div>
    <script>
        const {
            ClassicEditor,
            AccessibilityHelp,
            Alignment,
            AutoImage,
            Autosave,
            Base64UploadAdapter,
            BlockQuote,
            CloudServices,
            Code,
            CodeBlock,
            Essentials,
            GeneralHtmlSupport,
            ImageBlock,
            ImageInline,
            ImageInsert,
            ImageInsertViaUrl,
            ImageResize,
            ImageToolbar,
            ImageUpload,
            Indent,
            IndentBlock,
            List,
            ListProperties,
            Paragraph,
            SelectAll,
            SpecialCharacters,
            TodoList,
            Undo
        } = CKEDITOR;

        ClassicEditor
            .create( document.querySelector( '#editor' ),{
                toolbar: {
                    items: [
                        'undo',
                        'redo',
                        '|',
                        'code',
                        '|',
                        'specialCharacters',
                        'insertImage',
                        'blockQuote',
                        'codeBlock',
                        '|',
                        'alignment',
                        '|',
                        'bulletedList',
                        'numberedList',
                        'todoList',
                        'outdent',
                        'indent'
                    ],
                    shouldNotGroupWhenFull: true
                },
                plugins: [
                    AccessibilityHelp,
                    Alignment,
                    AutoImage,
                    Autosave,
                    Base64UploadAdapter,
                    BlockQuote,
                    CloudServices,
                    Code,
                    CodeBlock,
                    Essentials,
                    GeneralHtmlSupport,
                    ImageBlock,
                    ImageInline,
                    ImageInsert,
                    ImageInsertViaUrl,
                    ImageResize,
                    ImageToolbar,
                    ImageUpload,
                    Indent,
                    IndentBlock,
                    List,
                    ListProperties,
                    Paragraph,
                    SelectAll,
                    SpecialCharacters,
                    TodoList,
                    Undo
                ],
                htmlSupport: {
                    allow: [
                        {
                            name: /^.*$/,
                            styles: true,
                            attributes: true,
                            classes: true
                        }
                    ]
                },
                image: {
                    toolbar: ['imageTextAlternative', '|', 'resizeImage']
                },

                list: {
                    properties: {
                        styles: true,
                        startIndex: true,
                        reversed: true
                    }
                },
                placeholder: 'Type or paste your content here!'
            })
            .then( /* ... */ )
            .catch( /* ... */ );
    </script>
    <script type="text/javascript">
        const voteUp = document.getElementById("voteUp");
        const voteDown = document.getElementById("voteDown");
        const voteCount = document.getElementById("voteCount");
        let currentVote = parseInt([[${vote}]]);
        let userVote = parseInt([[${userVote}]]); // 0: chưa vote, 1: upvote, -1: downvote
        // Các icon khi được chọn và không được chọn
        const upvoteSelectedSrc = "../file/voteUpSelect.png";
        const upvoteDefaultSrc = "../file/voteUpDefault.png";
        const downvoteSelectedSrc = "../file/voteDownSelect.png";
        const downvoteDefaultSrc = "../file/voteDownDefault.png";
        // Hàm để cập nhật UI dựa trên trạng thái vote
        function updateVoteUI() {
            // Nếu người dùng đã chọn upvote
            if (userVote === 1) {
                voteUp.src = upvoteSelectedSrc;
                voteDown.src = downvoteDefaultSrc;
            }
            // Nếu người dùng đã chọn downvote
            else if (userVote === -1) {
                voteUp.src = upvoteDefaultSrc;
                voteDown.src = downvoteSelectedSrc;
            }
            // Nếu người dùng bỏ chọn vote
            else {
                voteUp.src = upvoteDefaultSrc;
                voteDown.src = downvoteDefaultSrc;
            }
        }
        // Sự kiện click cho nút upvote
        voteUp.addEventListener("click", function() {
            // Nếu người dùng đã upvote, nhấn lại để bỏ upvote
            if (userVote === 1) {
                currentVote -= 1;
                userVote = 0;
            }
            // Nếu người dùng chưa vote hoặc đã downvote, thì nhấn để upvote
            else {
                if (userVote === -1) {
                    currentVote += 2;
                } else {
                    currentVote += 1;
                }
                userVote = 1;
            }

            voteCount.textContent = currentVote;  // Cập nhật số vote trên UI
            updateVoteUI();
            sendInteractionRequest('up');
        });
        // Sự kiện click cho nút downvote
        voteDown.addEventListener("click", function() {
            if (userVote === -1) {
                currentVote += 1;
                userVote = 0;
            }
            else {
                if (userVote === 1) {
                    currentVote -= 2;
                } else {
                    currentVote -= 1;
                }
                userVote = -1;
            }

            voteCount.textContent = currentVote;  // Cập nhật số vote trên UI
            updateVoteUI();  // Cập nhật icon
            sendInteractionRequest('down');  // Gửi request lên server
        });
        // Hàm gửi request lên server
        function sendInteractionRequest(Type) {
            const data = {
                type: Type, // 'up' hoặc 'down'
                postId: [[${postID}]],
                userId: [[${userID}]]
            };

            fetch('/api/vote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.statusText)
                .then(data => {
                    console.log("Server response:", data);
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }

        const bookmark= document.getElementById("bookmark");
        let stateBookmark=  [[${bookmark}]];
        const bookmarkDefault= "../file/bookmark.png";
        const bookmarkSelect= "../file/bookmarkSelect.png";
        function updateBookmarkUI(){
            if(stateBookmark === 1){
                bookmark.src= bookmarkSelect;
            }
            else bookmark.src= bookmarkDefault;
        }
        bookmark.addEventListener("click",function(){
            if(stateBookmark === 1 ) stateBookmark=0;
            else stateBookmark=1;
            updateBookmarkUI();
            sendInteractionRequest('bookmark');
        });
    </script>
    <script type="text/javascript">
        document.getElementById('submitComment').addEventListener('submit', function(event) {
            // event.preventDefault(); // ngăn reload trang
            const comment = document.getElementById('editor');
            let content = comment.value;
            let data = {
                parentComment: 0,
                content: content,
                postId:[[${postId}]],
                username:[[${username}]]
            };

            // Gửi dữ liệu về server bằng Fetch API
            fetch('/createCmt', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.statusText)
                .then(data => {

                    console.log(data)
                })
                .catch((error) => {
                    console.error('Error:', error);
                })

        });

    </script>
</body>
</html>